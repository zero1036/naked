angular.module("ui.nd",["nd.wall","nd.sptable","nd.rollback"]),angular.module("nd.rollback",[]).directive("ndModelCommit",["$parse",function(e){return{restrict:"A",link:function(n,t,i){t.bind("click",function(){var t=angular.isDefined(i.action)?e(i.action):angular.noop,r=angular.isDefined(i.validation)?e(i.validation):angular.noop,l=angular.isDefined(i.commit)&&"true"===i.commit?!0:!1;n.$emit("ngModelActionRollback"+i.ndModelCommit,l,r),t(n),n.$apply()})}}}]).directive("ndModelRollback",function(){return{restrict:"A",scope:!1,require:"?ngModel",priority:20,link:function(e,n,t,i){var r=null;e.$on("ngModelActionRollback"+t.ndModelRollback,function(n,t,r){t&&(t=r(e,{vm:i.$viewValue}),t=void 0===t?!0:t),t?(i.$commitViewValue(),i.$render(),e.$apply()):(i.$rollbackViewValue(),i.$render())}),n.bind("blur",function(e){r=i.$viewValue,i.$rollbackViewValue(),i.$setViewValue(r),i.$render()})}}}),angular.module("nd.sptable",["ngAnimate"]).directive("ndSptable",function(){return{scope:{spArr:"=",spRow:"=",isLog:"@"},controller:"ndSptableCtrl"}}).controller("ndSptableCtrl",["$scope","$element","$attrs","$transclude","$parse",function(e,n,t,i,r){function l(e){for(var n,i=0,r=0;n=e[r++];){var l=n[t.scaleField];i+=l}return i}function o(e,n){var i=e[t.scaleField];angular.isDefined(t.widthUnit)&&angular.isDefined(t.widthPx)&&"px"===t.widthUnit?(e.width=parseInt(t.widthPx)*i/n,e.width=e.width+"px"):i===n&&0===i?e.width="100%":(e.width=i/n*100,e.width=e.width+"%")}function a(e){console.log("validate sptable");for(var n,i=null,r=0;n=e[r++];)null!==i&&i>n[t.rowField]&&console.log("！！！！sptable数据异常！！！！"),i=n[t.rowField],console.log("i:"+r+" | row:"+n[t.rowField]+" | col:"+n[t.colField]+" | isDel:"+n[t.isdelField]),"[object Number]"!=Object.prototype.toString.call(n[t.scaleField])&&console.log("！！！！对象属性"+t.scaleField+"只能为数值！！！！")}angular.isDefined(t.rowField)&&angular.isDefined(t.colField)&&angular.isDefined(t.scaleField)&&angular.isDefined(t.isdelField)&&(this.refreshArr=function(n,i){if(void 0!==n||(n=e.spArr,void 0!==n)){var s=angular.isDefined(t.onValidate)?r(t.onValidate):angular.noop,u=angular.isDefined(t.onRefresh)?r(t.onRefresh):angular.noop;e.spRow=0;for(var c=1;30>=c;c++){var d=n.filter(t.rowField,c);if(0===d.length)break;var g=d.filter(t.isdelField,!1);0!==g.length&&(e.spRow+=1);for(var f,p=l(g),h=s(e.$parent,{items:d}),$=0,m=0;f=d[m++];)f[t.isdelField]===!1&&(o(f,p),$+=1,f[t.colField]=$),f[t.rowField]=e.spRow,f.warn=void 0===h?!1:!h}e.isLog&&a(n),u(e.$parent,null)}},e.$watchCollection("spArr",this.refreshArr))}]).directive("ndSpitem",function(){return{require:["?^ndSptable","?^ndSpitem"],scope:{spItem:"="},controller:"ndSpitemCtrl",link:function(e,n,t,i){i[1].refreshParentArr=i[0].refreshArr}}}).controller("ndSpitemCtrl",["$scope","$element","$attrs","$transclude",function(e,n,t,i){this.refreshParentArr=angular.loop;var r=this;e.$watch(function(e){return e.spItem.width},function(e){n[0].style.width=e}),e.$watch(function(e){return e.spItem.warn},function(e){if(void 0!==e){var t=angular.element(n);e?t.addClass("spitem-warn"):t.removeClass("spitem-warn")}}),e.$watch(function(e){return e.spItem[t.scaleField]},function(e,n){if(e!==n){if(0===e)return;r.refreshParentArr()}}),e.$watch(function(e){return e.spItem[t.isdelField]},function(e,n){e!==n&&e&&r.refreshParentArr()})}]),function(){Array.prototype.single=function(e,n){for(var t,i=0;t=this[i++];)if(t[e]===n)return t;return void 0},Array.prototype.filter=function(e,n){for(var t,i=[],r=0;t=this[r++];)t[e]==n&&i.push(t);return i},Array.prototype.indexOf4Pro=function(e,n){for(var t,i=0;t=this[i++];)if(t[e]==n)return i-1;return-1},Array.prototype.contains=function(e){return this.indexOf(e)>=0},Array.prototype.resortNumber=function(e,n,t){for(var i,r=0;i=this[r++];)t(i)?(i[e]=n,n+=1):i[e]=-1}}(),function(){Date.prototype.Format=function(e){var n={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var t in n)new RegExp("("+t+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?n[t]:("00"+n[t]).substr((""+n[t]).length)));return e}}();var ut=angular.module("nd.util",[]);ut.factory("$$util",function(){var e={};return e.lastName=function(e,n){var t=/(\\+)/g,i=e.replace(t,"#"),r=i.split("#"),l=r[r.length-1],o=l.split("."),a=o[o.length-1],s=n.indexOf(a);return s>=0?!0:(alert("您选择的上传文件不是有效的图片文件！"),!1)},e.getChecked=function(e,n){var t="";if(null===e)return"";for(var i,r=0;i=e[r++];)i.isChecked&&(t+=i[n]+",");return t.length>0&&(t=t.substring(0,t.length-1)),t},e.sort=function(e,n){return e.sort(function(e,t){return e[n]-t[n]})},Date.prototype.Format=function(e){var n={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var t in n)new RegExp("("+t+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?n[t]:("00"+n[t]).substr((""+n[t]).length)));return e},e}),angular.module("nd.wall",["ngAnimate"]).constant("wallConfig",{openClass:"open"}).service("wallService",["$document","$rootScope",function(e,n){var t=null;this.open=function(n,r){t||e.bind("touchstart",i),t&&t!==n&&r&&1==r&&(t.isOpen=!1),t=n},this.close=function(n){t===n&&(t=null,e.unbind("click",i))};var i=function(e){if(t&&(!e||"disabled"!==t.getAutoClose())){var i=t.getToggleElement();if(!(e&&i&&i[0].contains(e.target))){var r=t.getDropdownElement();e&&"outsideClick"===t.getAutoClose()&&r&&r[0].contains(e.target)||(t.isOpen=!1,n.$$phase||t.$apply())}}}}]).controller("ndWallCtrl",["$scope","$attrs","$parse","wallConfig","wallService","$animate","$document","$compile","$templateRequest",function(e,n,t,i,r,l,o,a,s){var u,c=this,d=e.$new(),g=i.openClass,f=angular.noop,p=n.onToggle?t(n.onToggle):angular.noop,h=(o.find("body"),angular.isDefined(n.isOnly)?n.isOnly:!0);this.init=function(i){c.$element=i,n.isOpen&&(u=t(n.isOpen),f=u.assign,e.$watch(u,function(e){d.isOpen=!!e}))},this.toggle=function(e){return d.isOpen=arguments.length?!!e:!d.isOpen},this.isOpen=function(){return d.isOpen},d.getToggleElement=function(){return c.toggleElement},d.getAutoClose=function(){return n.autoClose||"always"},d.getElement=function(){return c.$element},d.getDropdownElement=function(){return c.dropdownMenu},d.focusToggleElement=function(){c.toggleElement&&c.toggleElement[0].focus()},d.$watch("isOpen",function(n,t){var i=c.$element;l[n?"addClass":"removeClass"](i,g).then(function(){angular.isDefined(n)&&n!==t&&p(e,{open:!!n})}),n?(d.focusToggleElement(),r.open(d,h)):r.close(d),angular.isFunction(f)&&f(e,n)}),e.$on("$locationChangeSuccess",function(){"disabled"!==d.getAutoClose()&&(d.isOpen=!1)});var $=e.$on("$destroy",function(){d.$destroy()});d.$on("$destroy",$)}]).directive("ndWall",function(){return{controller:"ndWallCtrl",link:function(e,n,t,i){i.init(n),n.addClass("nd-wall")}}}).directive("ndWallTogglePub",["$parse",function(e){return{link:function(n,t,i,r){if(angular.isDefined(i.isOpen)){var l,o=angular.noop;l=e(i.isOpen),o=l.assign;var a=function(e){e.preventDefault(),e.stopPropagation();var t=l(n);n.$apply(function(){o(n,!t)})};t.bind("click",a)}}}}]).directive("ndWallToggle",function(){return{require:"?^ndWall",link:function(e,n,t,i){if(i){n.addClass("nd-wall-toggle"),i.toggleElement=n;var r=function(r){r.preventDefault(),n.hasClass("disabled")||t.disabled||e.$apply(function(){i.toggle()})};n.bind("click",r),n.attr({"aria-haspopup":!0,"aria-expanded":!1}),e.$watch(i.isOpen,function(e){n.attr("aria-expanded",!!e)}),e.$on("$destroy",function(){n.unbind("click",r)})}}}});